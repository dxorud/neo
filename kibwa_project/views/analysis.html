<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EV | 데이터 분석</title>
  <link rel="stylesheet" href="analysis.css" />
</head>
<body>
  <header>
    <div class="container nav">
      <h1 class="logo">
        <a href="/" style="text-decoration: none; color: inherit;">⚡EV</a>
      </h1>
      <nav>
        <a href="/service">구매 예측</a>
        <a href="/map">충전소 지도</a>
        <a href="/analysis">데이터 분석</a>
      </nav>
    </div>
  </header>
  <section class="hero">
    <div class="container">
      <h2>전기차와 충전소의<br/>데이터를 분석해드립니다</h2>
      <p>다양한 그래프와 차트로 한눈에 살펴보세요</p>
    </div>
  </section>
  <section class="chart-section">
    <div class="container">
      <canvas id="barChart"></canvas>
    </div>
  </section>
  <section class="chart-section pie-chart-section">
    <div class="container">
      <canvas id="pieChart"></canvas>
    </div>
  </section>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = [
      '서울','부산','대구','인천','광주','대전','울산','세종',
      '경기','강원','충북','충남','전북','전남','경북','경남','제주'
    ];
    const rawDatasets = [
      { label:'2020-12', data:[23393,5355,12630,5366,3210,4469,2274,1148,20477,4078,3883,5489,3323,5223,7051,6308,21285], backgroundColor:'#FF8A65' },
      { label:'2021-12', data:[40564,12375,16185,12820,5194,7701,3166,1859,39958,7946,8194,9991,7365,8708,11240,12606,25571], backgroundColor:'#FFD54F' },
      { label:'2022-12', data:[59327,22063,24161,26242,9096,14476,5061,3034,77648,14012,15140,16611,12727,15387,19154,22740,32976], backgroundColor:'#4DB6AC' },
      { label:'2023-12', data:[72937,34643,30396,40397,12538,17889,7838,4393,114117,18236,19972,24130,19795,24200,26776,36225,39418], backgroundColor:'#90CAF9' },
      { label:'2024-07', data:[79548,40368,32631,48073,13820,19933,8883,4905,134741,19611,22759,27979,22494,28386,30810,43013,43117], backgroundColor:'#F06292' }
    ];
    const totals = labels.map((_,i)=>
      rawDatasets.reduce((sum,ds)=>sum+ds.data[i],0)
    );
    const sortedIdx = labels.map((_,i)=>i)
                            .sort((a,b)=>totals[b]-totals[a]);
    const sortedLabels = sortedIdx.map(i=>labels[i]);
    const sortedDatasets = rawDatasets.map(ds=>({
      ...ds,
      data: sortedIdx.map(i=>ds.data[i])
    }));
    const barData = { labels: sortedLabels, datasets: sortedDatasets };
    const barConfig = {
      type:'bar',
      data:barData,
      options:{
        responsive:true,
        plugins:{
          legend:{position:'top'},
          title:{ display:true, text:'선택된 년월별 지역별 전기차 등록 대수 (누적)' }
        },
        scales:{
          x:{ stacked:true, title:{display:true,text:'전기차 등록 대수'} },
          y:{ stacked:true, title:{display:true,text:'지역'} }
        }
      }
    };
    new Chart(
      document.getElementById('barChart').getContext('2d'),
      barConfig
    );
    const last = rawDatasets.find(d=>d.label==='2024-07');
    const arr = labels.map((lbl,i)=>({lbl,val:last.data[i]}))
                      .sort((a,b)=>b.val-a.val)
                      .slice(0,5);
    const pieData = {
      labels:arr.map(d=>d.lbl),
      datasets:[{
        data:arr.map(d=>d.val),
        backgroundColor:['#FF8A65','#FFD54F','#4DB6AC','#90CAF9','#F06292']
      }]
    };
    const pieConfig = {
      type:'pie',
      data:pieData,
      options:{
        responsive:true,
        plugins:{
          legend:{position:'top'},
          title:{ display:true, text:'2024년 7월 상위 5개 지역 비율' },
          tooltip:{
            callbacks:{
              label:ctx=>{
                const v=ctx.raw;
                const s=ctx.dataset.data.reduce((a,b)=>a+b,0);
                return `${ctx.label}: ${((v/s)*100).toFixed(1)}%`;
              }
            }
          }
        }
      }
    };
    new Chart(
      document.getElementById('pieChart').getContext('2d'),
      pieConfig
    );
  </script>
</body>
</html>
